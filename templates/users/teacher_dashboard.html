{# templates/users/teacher_dashboard.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Teacher Dashboard Overview{% endblock %}

{% block extra_head %}
    {# Only include head-specific links that are NOT in base.html #}
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />
    <link rel="stylesheet" href="{% static 'users/css/dashboard.css' %}">

    <style>
        /* Custom styles for equal height cards and notification font size */
        .equal-height-card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .equal-height-card .card-body {
            flex-grow: 1;
        }

        .notification-list .mb-1 {
            font-size: 1.5rem;
        }

        #page-content-wrapper {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        #main-dashboard-content {
            padding-top: 1.5rem;
        }

        .notification-list .notification-tag {
            font-size: 0.95rem; 
            padding: 0.3em 0.6em;
            border-radius: 12px; 
        }
        .notification-list small.text-muted {
            font-size: 0.9rem; 
        }
        /* Custom style for scrollable content */
        .scrollable-card-body {
            max-height: 350px; /* Adjust as needed */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
            padding-bottom: 0.5rem; /* Reduce bottom padding */
        }

        /* Added styles for notification message spacing and font size */
        .notification-message {
            margin-bottom: 0.5rem; /* Reduce space below message */
            font-size: 1.25rem;    /* Increase font size */
            line-height: 1.5;
        }

        .notification-title {
            font-size: 1.15rem;
            font-weight: bold;
        }

        /* Add this style to reduce card size */
        .small-dashboard-card {
            max-height: 300px; /* Adjust as needed */
            min-height: 250px; /* Ensure cards have a minimum height */
            flex: 1; /* Allow cards to grow equally */
            display: flex;
        }
    </style>
{% endblock %}

{% block sidebar_nav_items %} {# This block would be defined in your base.html #}
     {# Student Information #}
    <a href="#collapseStudentInfo" data-bs-toggle="collapse" aria-expanded="false" aria-controls="collapseStudentInfo"
       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
        <div><i class="fas fa-users me-2"></i>Student Information</div>
        <i class="fas fa-chevron-down fa-xs ms-auto"></i>
    </a>
    <div class="collapse" id="collapseStudentInfo" data-bs-parent="#sidebar-wrapper">
        <div class="list-group list-group-flush ps-3">
            {% if user.role == 'class_teacher' %}
                <a href="{% url 'student_list' %}" class="list-group-item list-group-item-action">View Class Students</a>
                <a href="{% url 'student_all_list' %}" class="list-group-item list-group-item-action">View All Students</a>
            {% elif user.role == 'academic_teacher' or user.role == 'subject_teacher' %}
                <a href="{% url 'student_all_list' %}" class="list-group-item list-group-item-action">View All Students</a>
            {% elif user.role == 'headteacher' or user.role == 'statistic_teacher' %}
                {# Headteachers and Statistic Teachers likely need to see all students #}
                <a href="{% url 'student_all_list' %}" class="list-group-item list-group-item-action">View All Students</a>
            {% endif %}
        </div>
    </div>

    {# Mark Management #}
    <a href="#collapseMarkManagement" data-bs-toggle="collapse" aria-expanded="false" aria-controls="collapseMarkManagement"
       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
        <div><i class="fas fa-edit me-2"></i>Mark Management</div>
        <i class="fas fa-chevron-down fa-xs ms-auto"></i>
    </a>
    <div class="collapse" id="collapseMarkManagement" data-bs-parent="#sidebar-wrapper">
        <div class="list-group list-group-flush ps-3">
            {% if user.role == 'class_teacher' %}
                <a href="{% url 'mark_entry_selection' %}" class="list-group-item list-group-item-action">Enter Class Marks</a>
                <a href="{% url 'mark_list' %}" class="list-group-item list-group-item-action">View Class Marks</a>
            {% elif user.role == 'academic_teacher' or user.role == 'subject_teacher' %}
                {# Academic and Subject teachers might enter/view marks for their subjects/all #}
                <a href="{% url 'mark_entry_selection' %}" class="list-group-item list-group-item-action">Enter Marks</a>
                <a href="{% url 'mark_list' %}" class="list-group-item list-group-item-action">View Marks</a>
            {% elif user.role == 'headteacher' or user.role == 'statistic_teacher' %}
                {# Headteachers and Statistic teachers would typically view all marks #}
                <a href="{% url 'mark_list' %}" class="list-group-item list-group-item-action">View All Marks</a>
                {# Maybe an "Enter Marks" link if they can oversee/correct #}
                <a href="{% url 'mark_entry_selection' %}" class="list-group-item list-group-item-action">Enter/Edit Marks</a>
            {% endif %}
        </div>
    </div>

    {# Performance & Results #}
    <a href="#collapsePerformance" data-bs-toggle="collapse" aria-expanded="false" aria-controls="collapsePerformance"
       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
        <div><i class="fas fa-chart-line me-2"></i>Performance & Results</div>
        <i class="fas fa-chevron-down fa-xs ms-auto"></i>
    </a>
    <div class="collapse" id="collapsePerformance" data-bs-parent="#sidebar-wrapper">
        <div class="list-group list-group-flush ps-3">
            <a href="{% url 'result_selection' %}" class="list-group-item list-group-item-action">Generate Results</a>
            <a href="#" class="list-group-item list-group-item-action">View Performance</a>
        </div>
    </div>

    {# Timetable & Attendance #}
    <a href="#collapseTimetableAttendance" data-bs-toggle="collapse" aria-expanded="false" aria-controls="collapseTimetableAttendance"
       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
        <div><i class="fas fa-calendar-check me-2"></i>Timetable & Attendance</div>
        <i class="fas fa-chevron-down fa-xs ms-auto"></i>
    </a>
    <div class="collapse" id="collapseTimetableAttendance" data-bs-parent="#sidebar-wrapper">
        <div class="list-group list-group-flush ps-3">
            <a href="{% url 'attendance_view' %}" class="list-group-item list-group-item-action">Mark Attendance</a>
            <a href="{% url 'timetable_view' %}" class="list-group-item list-group-item-action">View Timetable</a>
        </div>
    </div>
{% endblock %}

{% block dashboard_page_title %}Teacher Dashboard{% endblock %}

{% block content %} {# This is the main content block from base.html #}
    {# Your current dashboard main content goes here #}
    <div class="row">
        <!-- Section 5: Total Student Number -->
        <div class="col-lg-3 col-md-5 mb-4 d-flex">
            <div class="card w-100 equal-height-card small-dashboard-card">
                <div class="card-header bg-primary text-white"><i class="bi bi-person-lines-fill"></i>Total Students</div>
                <div class="card-body text-center d-flex flex-column justify-content-center align-items-center">
                    <img src="{% static 'users/img/student.jpeg' %}" alt="Students Icon" class="mb-2" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%;">
                    <h4 class="mb-1">Boys: {{ total_boys }}</h4>
                    <h4 class="mb-1">Girls: {{ total_girls }}</h4>
                    <p class="text-muted mb-0">Registered in school</p>
                </div>
            </div>
        </div>

        <!-- New row for "Documents for School" and "School Calendar" -->
        <div class="col-lg-9 col-md-7 mb-4 d-flex flex-column">
            <div class="row g-4 h-100">
                <div class="col-lg-6 col-md-12 d-flex">
                    <div class="card w-100 equal-height-card small-dashboard-card">
                        <div class="card-header bg-success text-white"><i class="bi bi-file-earmark-text"></i>Documents for School</div>
                        <div class="card-body scrollable-card-body"> {# Added scrollable-card-body class #}
                            {% if school_documents %}
                                <ul class="list-group list-group-flush">
                                    {% for doc in school_documents %}
                                        <li class="list-group-item d-flex flex-column align-items-start">
                                            <div class="d-flex w-100 justify-content-between">
                                                <div class="fw-bold">{{ doc.title }}</div>
                                                <small class="text-muted">{{ doc.get_document_type_display }}</small>
                                            </div>
                                            <small class="text-muted mb-2">{{ doc.published_date|date:"M d, Y H:i" }}</small>
                                            {% if doc.content %}
                                                <p class="mb-1 text-secondary">{{ doc.content|truncatechars:150 }}</p>
                                            {% endif %}
                                            <div class="mt-2">
                                                {% if doc.file %}
                                                    <a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-outline-info me-2"><i class="fas fa-download me-1"></i> Download</a>
                                                {% endif %}
                                                {% if doc.external_url %}
                                                    <a href="{{ doc.external_url }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-external-link-alt me-1"></i> View Link</a>
                                                {% endif %}
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted text-center mt-3">No documents or announcements available.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-12 d-flex">
                    <div class="card w-100 equal-height-card small-dashboard-card">
                        <div class="card-header bg-warning text-white"><i class="bi bi-calendar-event me-2"></i>School Calendar</div>
                        <div class="card-body">
                            <div id="calendar" class="text-center">
                                <h5 id="calendar-month-year" class="mb-3"></h5>
                                <div class="d-grid gap-1" style="grid-template-columns: repeat(7, 1fr); font-size: 0.85rem;">
                                    <div class="fw-bold">Sun</div>
                                    <div class="fw-bold">Mon</div>
                                    <div class="fw-bold">Tue</div>
                                    <div class="fw-bold">Wed</div>
                                    <div class="fw-bold">Thu</div>
                                    <div class="fw-bold">Fri</div>
                                    <div class="fw-bold">Sat</div>
                                </div>
                                <div id="calendar-days" class="d-grid gap-1 mt-2" style="grid-template-columns: repeat(7, 1fr); font-size: 0.85rem;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="calendarNoteModal" tabindex="-1" aria-labelledby="calendarNoteModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <form class="modal-content" id="calendar-note-form">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="calendarNoteModalLabel">Add Note to Calendar</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <label for="note-date" class="form-label">Date</label>
                            <input type="date" class="form-control mb-3" id="note-date" name="note_date" required>

                            <label for="note-content" class="form-label">Note</label>
                            <textarea class="form-control" id="note-content" name="note_content" rows="3" placeholder="Enter your note here..." required></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-warning">Save Note</button>
                        </div>
                    </form>
                </div>
            </div>
            </div>
        </div>
    </div>

    <div class="row">
        {# Section 7: Class Students (Donut Chart) #}
        <div class="col-lg-7 mb-5 d-flex">
            <div class="card w-100 equal-height-card">
                <div class="card-header bg-info d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-dark"><i class="bi bi-people-fill"></i>Students <span class="badge bg-secondary ms-2">In My Class(es)</span></h5>
                    <i class="fas fa-ellipsis-h text-muted"></i>
                </div>
                <div class="card-body">
                    <canvas id="studentChart" style="max-height: 300px;"></canvas>
                    <div class="d-flex justify-content-around mt-3">
                        <div class="text-center">
                            <span class="badge" style="background-color: #427cff; padding: 5px; border-radius: 3px;"></span> Female Students
                            <div class="fw-bold">{{ teacher_class_girls|default:0 }}</div>
                        </div>
                        <div class="text-center">
                            <span class="badge" style="background-color: #ffb12c; padding: 5px; border-radius: 3px;"></span> Male Students
                            <div class="fw-bold">{{ teacher_class_boys|default:0 }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-5 mb-5 d-flex">
        <div class="card w-100 equal-height-card">
            <div class="card-header bg-danger d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-dark"><i class="bi bi-bell-fill"></i>Notifications</h5>
                <i class="fas fa-ellipsis-h text-muted"></i>
            </div>
            <div class="card-body scrollable-card-body">
                <ul class="list-group list-group-flush notification-list">
                    {% if notifications %}
                        {% for notification in notifications %}
                            <li class="list-group-item">
                                <span class="notification-tag {{ notification.get_tag_class }}">{{ notification.published_date|date:"M d, Y" }}</span>
                                <h6 class="notification-title mb-1">{{ notification.title }}</h6>
                                <p class="notification-message">{{ notification.message|truncatechars:100 }}</p>
                                <small class="text-muted">
                                    From: {{ notification.notify_from|default:"N/A" }} / {{ notification.published_date|timesince }} ago
                                </small>
                            </li>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center mt-3">No new notifications.</p>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    </div>
{% endblock %}

{% block extra_js %}
    {# JSON Data for Chart.js #}
    <script id="student-chart-data" type="application/json">
        {
        "boys": {{ teacher_class_boys|default:0 }},
        "girls": {{ teacher_class_girls|default:0 }}
        }
    </script>

    <script>
        // Chart.js for Student Distribution (Donut Chart)
        const ctx = document.getElementById('studentChart');
        if (ctx) {
            const studentDataElement = document.getElementById('student-chart-data');
            const studentCounts = JSON.parse(studentDataElement.textContent);

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Female Students', 'Male Students'],
                    datasets: [{
                        data: [
                            studentCounts.girls,
                            studentCounts.boys
                        ],
                        backgroundColor: ['#427cff', '#ffb12c'],
                        borderColor: '#fff',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        const calendarDaysEl = document.getElementById('calendar-days');
        const monthYearEl = document.getElementById('calendar-month-year');
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();

        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        function generateCalendar(year, month) {
            calendarDaysEl.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            monthYearEl.textContent = `${monthNames[month]} ${year}`;

            for (let i = 0; i < firstDay; i++) {
                calendarDaysEl.innerHTML += `<div></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const today = day === now.getDate() && month === now.getMonth() && year === now.getFullYear();
                calendarDaysEl.innerHTML += `<div class="${today ? 'bg-primary text-white rounded' : ''}">${day}</div>`;
            }
        }

        generateCalendar(year, month);
    </script>
{% endblock %}