{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %} {# This line is correctly here, keep it! #}

{% block title %}View Marks - Sibwesa Primary School{% endblock %}

{% block extra_head %}
<style>
    /* Global page padding */
    .container {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
    }

    /* Custom styles for extreme compactness of the filter form */
    .filter-card {
        border-radius: 0.75rem; /* Consistent rounding */
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1); /* Subtle shadow */
    }

    .card-header.compact-filter-header {
        padding-top: 0.75rem !important; /* Slightly more padding for aesthetics */
        padding-bottom: 0.75rem !important;
        font-size: 1.1rem; /* Slightly larger header font */
        border-top-left-radius: 0.75rem !important;
        border-top-right-radius: 0.75rem !important;
        background: linear-gradient(to right, var(--bs-primary), var(--bs-primary-light, #6610f2)); /* Gradient */
        color: white; /* Ensure text is white */
    }
    .card-body.compact-filter-body {
        padding: 1rem !important; /* Adjusted padding inside card body */
    }

    /* Reduce vertical spacing around labels and fields */
    .form-group-tiny .mb-2 { /* A custom class to target the div around each field */
        margin-bottom: 0.5rem !important; /* Slightly more margin-bottom than 0.25rem for readability */
    }
    .form-group-tiny .form-label {
        margin-bottom: 0.2rem !important; /* Minimal space between label and input */
        font-size: 0.875rem; /* Standard smaller label font */
        font-weight: 500; /* Semi-bold label */
    }

    /* Make form controls (selects) even smaller in height and font */
    .form-control.super-compact-input {
        height: 32px !important; /* Adjusted height for inputs/selects for better touch target */
        padding: 0.375rem 0.75rem !important; /* Reduced internal padding */
        font-size: 0.875rem !important; /* Smaller font inside inputs */
    }

    /* Make buttons smaller */
    .btn.btn-super-compact {
        padding: 0.3rem 0.75rem !important; /* Smaller padding for buttons */
        font-size: 0.875rem !important; /* Smaller font for buttons */
    }

    /* Styling for individual mark cards */
    .mark-card .card-header {
        padding: 0.75rem 1.25rem; /* Standard card header padding */
        font-size: 1rem;
    }
    .mark-card .card-body {
        padding: 1rem 1.25rem; /* Standard card body padding */
    }
    .mark-card .card-text {
        margin-bottom: 0.5rem; /* Space between text lines */
        font-size: 0.9rem; /* Slightly smaller text in cards */
    }
    .mark-card .card-title {
        margin-bottom: 0; /* Remove bottom margin from title in card */
        font-size: 1.25rem; /* Standard h5 size */
    }
    .mark-card .badge {
        font-size: 1.1em; /* Larger badge for score */
        padding: 0.5em 0.7em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">View Marks</h1>
        <p class="lead text-muted">Filter and view marks entered for students.</p>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-4" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    {# Filter Card #}
    <div class="row justify-content-center mb-5"> {# Increased margin-bottom for spacing #}
        <div class="col-lg-8 col-md-9"> {# Adjusted column width for slightly more space, still compact #}
            <div class="card filter-card">
                <div class="card-header compact-filter-header">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Marks</h5> {# Added icon #}
                </div>
                <div class="card-body compact-filter-body">
                    <form method="get" action="{% url 'mark_list' %}">
                        <div class="row g-2 align-items-end"> {# Changed g-1 to g-2 for slightly more space, align-items-end to align labels #}
                            <div class="col-md-4 col-sm-6 form-group-tiny">
                                <label for="{{ form.examination.id_for_label }}" class="form-label">Examination</label>
                                {{ form.examination|add_class:"form-select super-compact-input" }} {# Use form-select #}
                            </div>
                            <div class="col-md-4 col-sm-6 form-group-tiny">
                                <label for="{{ form.class_name.id_for_label }}" class="form-label">Class</label>
                                {{ form.class_name|add_class:"form-select super-compact-input" }} {# Use form-select #}
                            </div>
                            <div class="col-md-4 col-sm-12 form-group-tiny">
                                <label for="{{ form.subject.id_for_label }}" class="form-label">Subject</label>
                                {{ form.subject|add_class:"form-select super-compact-input" }} {# Use form-select #}
                            </div>
                            <div class="col-12 d-flex justify-content-end mt-2"> {# Adjusted margin-top #}
                                <button type="submit" class="btn btn-primary me-2 btn-super-compact">
                                    <i class="fas fa-search me-1"></i> Apply Filters
                                </button>
                                <a href="{% url 'mark_list' %}" class="btn btn-outline-secondary btn-super-compact">
                                    <i class="fas fa-times-circle me-1"></i> Clear Filters
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# Current Marks Display Section #}
    <div class="card shadow-lg border-0 rounded-4"> {# Main card for marks #}
        <div class="card-header bg-success text-white text-center py-3 rounded-top-4"> {# New gradient header #}
            <h5 class="mb-0">
                <i class="fas fa-clipboard-list me-2"></i>Current Marks
                {% if selected_examination %}: {{ selected_examination.name }}{% endif %}
                {% if selected_class %}, Class: {{ selected_class.name }}{% endif %}
                {% if selected_subject %}, Subject: {{ selected_subject.name }}{% endif %}
            </h5>
        </div>
        <div class="card-body p-4"> {# Ample padding #}
            {% if marks %}
                <div class="row g-4"> {# Increased gutter for better spacing between mark cards #}
                    {% for mark in marks %}
                        <div class="col-xxl-3 col-lg-4 col-md-6 col-12"> {# Adjusted columns for more items per row on larger screens #}
                            <div class="card h-100 shadow-sm border rounded-3 mark-card"> {# Added border, rounded corners #}
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-user-circle me-2"></i>Student: {{ mark.student.get_full_name }}</h6>
                                </div>
                                <div class="card-body">
                                    <p class="card-text"><strong>Admission No.:</strong> {{ mark.student.admission_number }}</p>
                                    <p class="card-text"><strong>Class:</strong> {{ mark.student.current_class.name }}</p>
                                    <p class="card-text"><strong>Examination:</strong> {{ mark.examination.name }}</p>
                                    <p class="card-text"><strong>Subject:</strong> {{ mark.subject.name }}</p>
                                    <h5 class="card-title mt-3">Score: <span class="badge bg-success">{{ mark.score|default_if_none:"N/A" }}</span></h5>
                                </div>
                                <div class="card-footer d-flex justify-content-end bg-light border-top"> {# Light footer background #}
                                    <a href="{% url 'mark_entry_selection' %}?exam_id={{ mark.examination.pk }}&class_id={{ mark.student.current_class.pk }}&subject_id={{ mark.subject.pk }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit me-1"></i> Edit Group Marks
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="alert alert-info text-center py-3 mb-0">
                    <i class="fas fa-info-circle me-2"></i> No marks found matching your criteria. Try adjusting your filters.
                </p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{# Ensure Font Awesome is loaded if not in base.html #}
<script src="https://kit.fontawesome.com/YOUR_FONT_AWESOME_KIT_ID.js" crossorigin="anonymous"></script> {# REPLACE THIS #}
{% endblock %}